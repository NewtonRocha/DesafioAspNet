@{
    ViewData["Title"] = "Dashboard";
    Layout = "_Layout";
}

<div class="right_col" role="main">

    <!-- top tiles -->
    <div class="row tile_count">
        <div class="animated flipInY col-md-2 col-sm-4 col-xs-4 tile_stats_count">
            <div class="left"></div>
            <div class="right">
                <span class="count_top"><i class="fa fa-user"></i> Total de usuários</span>
                <div class="count userCount">0</div>
                <span class="count_bottom"><i class="green"><i class="fa fa-sort-asc"></i>100% </i> Desde a última semana</span>
            </div>
        </div>
        <div class="animated flipInY col-md-2 col-sm-4 col-xs-4 tile_stats_count">
            <div class="left"></div>
            <div class="right">
                <span class="count_top"><i class="fa fa-clock-o"></i> Tempo médio de atividades</span>
                <div class="count atividadeTimeCount">0</div>
                <span class="count_bottom"><i class="green"><i class="fa fa-sort-asc"></i>100% </i> Desde a última semana</span>
            </div>
        </div>
        <div class="animated flipInY col-md-2 col-sm-4 col-xs-4 tile_stats_count">
            <div class="left"></div>
            <div class="right">
                <span class="count_top"><i class="fa fa-user"></i> Atividades em andamento</span>
                <div class="count green atividadeAndamentoCount">0</div>
                <span class="count_bottom"><i class="red"><i class="fa fa-sort-asc"></i>100% </i> Desde a última semana</span>
            </div>
        </div>
        <div class="animated flipInY col-md-2 col-sm-4 col-xs-4 tile_stats_count">
            <div class="left"></div>
            <div class="right">
                <span class="count_top"><i class="fa fa-user"></i> Atividades finalizadas</span>
                <div class="count atividadeFinalCount">0</div>
                <span class="count_bottom"><i class="green"><i class="fa fa-sort-asc"></i>100% </i> Desde a última semana</span>
            </div>
        </div>
        <div class="animated flipInY col-md-2 col-sm-4 col-xs-4 tile_stats_count">
            <div class="left"></div>
            <div class="right">
                <span class="count_top"><i class="fa fa-user"></i> Total de atividades</span>
                <div class="count atividadeCount">0</div>
                <span class="count_bottom"><i class="green"><i class="fa fa-sort-asc"></i>100% </i> Desde a última semana</span>
            </div>
        </div>
        <div class="animated flipInY col-md-2 col-sm-4 col-xs-4 tile_stats_count">
            <div class="left"></div>
            <div class="right">
                <span class="count_top"><i class="fa fa-user"></i> Usuários Desativados</span>
                <div class="count userDesativado">0</div>
                <span class="count_bottom"><i class="red"><i class="fa fa-sort-asc"></i>100% </i> Desde a última semana</span>
            </div>
        </div>

    </div>
    <!-- /top tiles -->

    <div class="row">
        <div class="col-md-12 col-sm-12 col-xs-12">
            <div class="dashboard_graph">

                <div class="row x_title">
                    <div class="col-md-6">
                        <h3>
                            Atividades<small> em andamento</small>
                        </h3>
                    </div>
                    <div class="col-md-6">
                        <div id="reportrange" class="pull-right" style="background: #fff; cursor: pointer; padding: 5px 10px; border: 1px solid #ccc">
                            <i class="glyphicon glyphicon-calendar fa fa-calendar"></i>
                            <span>July 03, 2016 - July 07, 2016</span> <b class="caret"></b>
                        </div>
                    </div>
                </div>

                <div class="col-md-12 col-sm-12 col-xs-12">
                    <div id="placeholder33" style="height: 260px; display: none" class="demo-placeholder"></div>
                    <div style="width: 100%;">
                        <div id="canvas_dahs" class="demo-placeholder" style="width: 100%; height: 270px;"></div>
                    </div>
                </div>

                <div class="clearfix"></div>
            </div>
        </div>

    </div>
    <br />

    <!--Bottom Tiles-->
    <div class="row">


        <div class="col-md-4 col-sm-4 col-xs-12">
            <div class="x_panel tile fixed_height_320">
                <div class="x_title">
                    <h2>Usuários</h2>
                    <ul class="nav navbar-right panel_toolbox">
                        <li>
                            <a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                        </li>
                        <li class="dropdown">
                            <a href="lib/gentelella/production/#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><i class="fa fa-wrench"></i></a>
                            <ul class="dropdown-menu" role="menu">
                                <li>
                                    <a href="lib/gentelella/production/#">Settings 1</a>
                                </li>
                                <li>
                                    <a href="lib/gentelella/production/#">Settings 2</a>
                                </li>
                            </ul>
                        </li>
                        <li>
                            <a class="close-link"><i class="fa fa-close"></i></a>
                        </li>
                    </ul>
                    <div class="clearfix"></div>
                </div>
                <div class="x_content userEff">
                    <h4>Usuários mais Eficientes</h4>
                </div>
            </div>
        </div>

        <div class="col-md-4 col-sm-4 col-xs-12">
            <div class="x_panel tile fixed_height_320 overflow_hidden">
                <div class="x_title">
                    <h2>Número de Atividades</h2>
                    <ul class="nav navbar-right panel_toolbox">
                        <li>
                            <a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                        </li>
                        <li class="dropdown">
                            <a href="lib/gentelella/production/#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><i class="fa fa-wrench"></i></a>
                            <ul class="dropdown-menu" role="menu">
                                <li>
                                    <a href="lib/gentelella/production/#">Settings 1</a>
                                </li>
                                <li>
                                    <a href="lib/gentelella/production/#">Settings 2</a>
                                </li>
                            </ul>
                        </li>
                        <li>
                            <a class="close-link"><i class="fa fa-close"></i></a>
                        </li>
                    </ul>
                    <div class="clearfix"></div>
                </div>
                <div class="x_content">
                    <table class="" style="width: 100%">
                        <tr>
                            <th style="width: 37%;">
                                <p>Top 5</p>
                            </th>
                            <th>
                                <div class="col-lg-7 col-md-7 col-sm-7 col-xs-7">
                                    <p class="">Usuário</p>
                                </div>
                                <div class="col-lg-5 col-md-5 col-sm-5 col-xs-5">
                                    <p class="">Atividades</p>
                                </div>
                            </th>
                        </tr>
                        <tr>
                            <td>
                                <canvas id="canvas1" height="140" width="140" style="margin: 15px 10px 10px 0"></canvas>
                            </td>
                            <td>
                                <table class="tile_info"></table>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-md-4 col-sm-4 col-xs-12">
            <div class="x_panel tile fixed_height_320 overflow_hidden">
                <div class="x_title">
                    <h2>Usuários</h2>
                    <ul class="nav navbar-right panel_toolbox">
                        <li>
                            <a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                        </li>
                        <li class="dropdown">
                            <a href="lib/gentelella/production/#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><i class="fa fa-wrench"></i></a>
                            <ul class="dropdown-menu" role="menu">
                                <li>
                                    <a href="lib/gentelella/production/#">Settings 1</a>
                                </li>
                                <li>
                                    <a href="lib/gentelella/production/#">Settings 2</a>
                                </li>
                            </ul>
                        </li>
                        <li>
                            <a class="close-link"><i class="fa fa-close"></i></a>
                        </li>
                    </ul>
                    <div class="clearfix"></div>
                </div>
                <div class="x_content">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Usuário</th>
                                <th>Cargo</th>
                                <th>Cliente</th>
                            </tr>
                        </thead>
                        <tbody class="userTable">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        //Gera grafico principal da pagina de atividades.
        $(document)
            .ready(function () {
                jQuery.get("http://localhost:59633/api/atividade",
                    function (response) {
                        console.log(response);
                        //verifica quantas atividades temos por dia.
                        var data1 = {};
                        for (i = 0; i < response.length; i++) {
                            var date = response[i].inicio;
                            if (isNaN(data1[date])) {
                                data1[date] = 0;
                            }
                            data1[date] += 1;
                        }

                        var total = response.length;
                        var ative = 0;
                        var time = 0;
                        var j = 1;
                        for (i = 0; i < total; i++) {
                            if (response[i]["termino"] == null) {
                                ative += 1;
                            } else {
                                var diffMs = (new Date(response[i].termino) - new Date(response[i].inicio));
                                var diffHrs = Math.round((diffMs) / 3600000); // horas
                                console.log(diffMs);
                                console.log(diffHrs);
                                time = (time + diffHrs) / j;
                                j++;
                            }
                        }

                        $(".atividadeAndamentoCount").text(ative);
                        $(".atividadeCount").text(total);
                        $(".atividadeFinalCount").text(total - ative);
                        $(".atividadeTimeCount").text(time + " h");

                        //Formata os dados de acordo com os dados necessarios para o grafico
                        var data2 = [];
                        for (i = 0; i < Object.keys(data1).length; i++) {
                            data2.push([new Date(Object.keys(data1)[i]).getTime(), data1[Object.keys(data1)[i]]]);
                        }
                        data2.sort();

                        console.log(data2);
                        //Curve Chart
                        $("#canvas_dahs").length &&
                            $.plot($("#canvas_dahs"),
                            [
                                data2
                            ],
                            {
                                series: {
                                    lines: {
                                        show: false,
                                        fill: true
                                    },
                                    splines: {
                                        show: true,
                                        tension: 0.4,
                                        lineWidth: 1,
                                        fill: 0.4
                                    },
                                    points: {
                                        radius: 0,
                                        show: true
                                    },
                                    shadowSize: 2
                                },
                                grid: {
                                    verticalLines: true,
                                    hoverable: true,
                                    clickable: true,
                                    tickColor: "#d5d5d5",
                                    borderWidth: 1,
                                    color: '#fff'
                                },
                                colors: ["rgba(38, 185, 154, 0.38)", "rgba(3, 88, 106, 0.38)"],
                                xaxis: {
                                    tickColor: "rgba(51, 51, 51, 0.06)",
                                    mode: "time",
                                    tickSize: [1, "day"],
                                    axisLabel: "Date",
                                    axisLabelUseCanvas: true,
                                    axisLabelFontSizePixels: 12,
                                    axisLabelFontFamily: 'Verdana, Arial',
                                    axisLabelPadding: 10
                                },
                                yaxis: {
                                    ticks: 8,
                                    tickColor: "rgba(51, 51, 51, 0.06)",
                                },
                                tooltip: false
                            });
                    });
            });
    </script>

    <!-- script de pessoa -->
    <script>
        $('document')
            .ready(function () {
                $.get("http://localhost:59633/api/pessoa",
                    function (response) {
                        // calculos para preencher tiles de pessoas
                        var total = response.length;
                        var ative = 0;
                        var usersActFinal = {};
                        var usersAct = {};
                        var totalAct = 0;
                        for (i = 0; i < total; i++) {
                            if (response[i]["demissao"] == null) {
                                ative += 1;
                            }
                            $(".userTable").append('<tr><th scope="row">' + response[i]["nome"] + '</th><td>'+ response[i]["cargo"]["nome"] +'</td><td>' + response[i]["cliente"]["name"] + '</td></tr>');
                            for (j = 0; j < response[i].atividades.length; j++) {
                                if (response[i].atividades[j]["termino"] != null) {
                                    if (usersActFinal[response[i]["nome"]] == null) {
                                        usersActFinal[response[i]["nome"]] = 0;
                                    }
                                    if (usersAct[response[i]["nome"]] == null) {
                                        usersAct[response[i]["nome"]] = 0;
                                    }
                                    usersActFinal[response[i]["nome"]] += 1;
                                } else {
                                    if (usersActFinal[response[i]["nome"]] == null) {
                                        usersActFinal[response[i]["nome"]] = 0;
                                    }
                                    if (usersAct[response[i]["nome"]] == null) {
                                        usersAct[response[i]["nome"]] = 0;
                                    }
                                    usersAct[response[i]["nome"]] += 1;
                                }
                                totalAct += 1;
                            }
                        }
                        $(".userCount").text(total);
                        $(".userDesativado").text(total - ative);

                        //Tile de Usuários mais eficientes
                        for (i = 0; i < Object.keys(usersActFinal).length; i++) {
                            $(".userEff")
                                .append(
                                    '<div class="widget_summary"> <div class="w_left w_25">  <span>' +
                                    Object.keys(usersActFinal)[i] +
                                    '</span> </div> <div class="w_center w_55">  <div class="progress">  <div class= "progress-bar bg-green" role = "progressbar"' +
                                    'aria - valuenow = "' +
                                    usersActFinal[Object.keys(usersActFinal)[i]] +
                                    '" aria - valuemin = "0" aria - valuemax = "' +
                                    totalAct +
                                    '" style = "width: ' +
                                    (usersActFinal[Object.keys(usersActFinal)[i]] / totalAct) * 100 +
                                    '%;">  <span class="sr-only" > ' +
                                    (usersActFinal[Object.keys(usersActFinal)[i]] / totalAct) * 100 +
                                    '%  </span >  </div >  </div >  </div >  <div class="w_right w_20">  <span>' +
                                    usersActFinal[Object.keys(usersActFinal)[i]] +
                                    '</span >  </div>  <div class="clearfix">  </div >  </div >');
                        }

                        // Doughnut Chart
                        var options = {
                            legend: false,
                            responsive: false
                        };

                        var labels = [];
                        var chartData = [];
                        var colors = [
                            "#BDC3C7",
                            "#9B59B6",
                            "#E74C3C",
                            "#26B99A",
                            "#3498DB"
                        ];
                        var i = 0;

                        for (key in usersAct) {
                            if (i < 5) {
                                labels.push(key);
                                chartData.push(usersAct[key]);
                                $(".tile_info")
                                    .append('<tr><td><p><i class="fa fa-square" style="color: ' + colors[i] + ';"></i>' +
                                        key +
                                        '</p></td><td>' +
                                        usersAct[key] +
                                        '</td></tr>');
                                i++;
                            }
                        }

                        new Chart(document.getElementById("canvas1"),
                        {
                            type: 'doughnut',
                            tooltipFillColor: "rgba(51, 51, 51, 0.55)",
                            data: {
                                labels: labels,
                                datasets: [
                                    {
                                        data: chartData,
                                        backgroundColor: [
                                            "#BDC3C7",
                                            "#9B59B6",
                                            "#E74C3C",
                                            "#26B99A",
                                            "#3498DB"
                                        ],
                                        hoverBackgroundColor: [
                                            "#CFD4D8",
                                            "#B370CF",
                                            "#E95E4F",
                                            "#36CAAB",
                                            "#49A9EA"
                                        ]
                                    }
                                ]
                            },
                            options: options
                        });
                    });
            });
    </script>
    <script>
        NProgress.done();
    </script>
}




